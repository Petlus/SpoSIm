#!/usr/bin/env node
/**
 * Update electron/data/leagues with current player data for Season 2025/26
 * Fetches from api-football.com (requires API_FOOTBALL_KEY in .env)
 *
 * Usage: node electron/scripts/update-leagues-data.js
 *        node electron/scripts/update-leagues-data.js --dry-run  (no file writes)
 */

require('dotenv').config();
const axios = require('axios');
const fs = require('fs');
const path = require('path');

const API_FOOTBALL_KEY = process.env.API_FOOTBALL_KEY || '';
const API_FOOTBALL_URL = 'https://v3.football.api-sports.io';
const BL_LEAGUE_ID = 78;
const SEASON = 2025;

// Team name (from leagues module.exports.name) -> api-football.com team ID
const BL_TEAM_MAP = {
    'FC Bayern München': 157,
    'Borussia Dortmund': 165,
    'RB Leipzig': 173,
    'Bayer 04 Leverkusen': 168,
    'VfL Wolfsburg': 163,
    'Eintracht Frankfurt': 169,
    'SC Freiburg': 172,
    'VfB Stuttgart': 160,
    'SV Werder Bremen': 162,
    'Borussia Mönchengladbach': 167,
    'TSG Hoffenheim': 159,
    '1. FC Union Berlin': 170,
    '1. FC Köln': 180,
    'FC Augsburg': 164,
    '1. FC Heidenheim 1846': 181,
    'FC St. Pauli': 80,
    'Hamburger SV': 81,
    '1. FSV Mainz 05': 174,
};

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

function mapPosition(pos) {
    if (!pos) return 'SUB';
    const p = String(pos).toLowerCase();
    if (p.includes('goalkeeper')) return 'GK';
    if (p.includes('defender')) return 'DEF';
    if (p.includes('midfielder')) return 'MID';
    if (p.includes('attacker') || p.includes('forward')) return 'FW';
    return 'SUB';
}


/** Convert api-football rating (6.0-9.0) to Kicker note (1.0-6.0, 1=best) */
function apiRatingToKicker(apiRating) {
    if (!apiRating || apiRating < 5) return null;
    // API 9.0 -> Kicker 1.0, API 7.0 -> Kicker 2.5, API 6.0 -> Kicker 3.5
    const kicker = 6 - (apiRating - 5) * 1.25;
    return Math.round(Math.max(1, Math.min(6, kicker)) * 100) / 100;
}

function formatSquadJs(teamMeta, squad) {
    const lines = squad.map((p) => {
        const noteStr = p.kickerNote != null ? p.kickerNote : 'null';
        const goalsStr = p.goals ?? 0;
        return `        { name: "${p.name.replace(/"/g, '\\"')}", position: "${p.position}", kickerNote: ${noteStr}, goals: ${goalsStr} }`;
    });
    return `// ${teamMeta.name} - Squad Data
// Source: api-football.com (Season ${SEASON}/${SEASON + 1})
// Generated by update-leagues-data.js

module.exports = {
    name: "${teamMeta.name}",
    shortName: "${teamMeta.shortName}",
    kickerSlug: "${teamMeta.kickerSlug}",
    marketValue: ${teamMeta.marketValue},
    squad: [
${lines.join(',\n')}
    ]
};
`;
}

async function fetchSquad(apiTeamId) {
    const res = await axios.get(`${API_FOOTBALL_URL}/players/squads?team=${apiTeamId}`, {
        headers: { 'x-rapidapi-key': API_FOOTBALL_KEY, 'x-rapidapi-host': 'v3.football.api-sports.io' },
    });
    const players = res.data?.response?.[0]?.players;
    if (!players) return [];
    return players
        .map((p) => ({
            name: p.name,
            position: mapPosition(p.position),
            number: p.number ?? 99,
        }))
        .sort((a, b) => a.number - b.number)
        .slice(0, 28);
}

async function fetchTopPlayers() {
    const map = {};
    let season = SEASON;
    for (const endpoint of ['topscorers', 'topassists']) {
        await sleep(300);
        let res = await axios.get(
            `${API_FOOTBALL_URL}/players/${endpoint}?league=${BL_LEAGUE_ID}&season=${season}`,
            { headers: { 'x-rapidapi-key': API_FOOTBALL_KEY, 'x-rapidapi-host': 'v3.football.api-sports.io' } }
        );
        if ((res.data?.response?.length ?? 0) === 0 && season === SEASON) {
            season = SEASON - 1;
            await sleep(300);
            res = await axios.get(
                `${API_FOOTBALL_URL}/players/${endpoint}?league=${BL_LEAGUE_ID}&season=${season}`,
                { headers: { 'x-rapidapi-key': API_FOOTBALL_KEY, 'x-rapidapi-host': 'v3.football.api-sports.io' } }
            );
        }
        const list = res.data?.response || [];
        for (const p of list) {
            const name = p.player?.name;
            if (name) {
                const stats = p.statistics?.[0];
                const existing = map[name] || { goals: 0, assists: 0, rating: null };
                map[name] = {
                    goals: existing.goals + (stats?.goals?.total ?? 0),
                    assists: existing.assists + (stats?.goals?.assists ?? 0),
                    rating: parseFloat(stats?.games?.rating) || existing.rating,
                };
            }
        }
    }
    return map;
}


async function main() {
    const dryRun = process.argv.includes('--dry-run');

    if (!API_FOOTBALL_KEY) {
        console.error('Error: API_FOOTBALL_KEY required in .env');
        process.exit(1);
    }

    const leaguesPath = path.join(__dirname, '..', 'data', 'leagues', 'bundesliga');
    const teamFiles = fs.readdirSync(leaguesPath).filter((f) => f.endsWith('.js') && f !== 'index.js');

    console.log('Fetching top scorers & assists...');
    const topPlayers = await fetchTopPlayers();
    console.log(`  -> ${Object.keys(topPlayers).length} players with stats`);

    for (const file of teamFiles) {
        const teamPath = path.join(leaguesPath, file);
        const teamModule = require(teamPath);
        const teamName = teamModule.name;
        const apiTeamId = BL_TEAM_MAP[teamName];

        if (!apiTeamId) {
            console.log(`  Skip ${teamName} (no API mapping)`);
            continue;
        }

        await sleep(400);
        const squad = await fetchSquad(apiTeamId);

        if (squad.length === 0) {
            console.log(`  Skip ${teamName} (no squad data)`);
            continue;
        }

        const merged = squad.map((p) => {
            const tp = topPlayers[p.name];
            return {
                ...p,
                goals: tp?.goals ?? 0,
                kickerNote: tp?.rating ? apiRatingToKicker(tp.rating) : null,
            };
        });

        const meta = {
            name: teamModule.name,
            shortName: teamModule.shortName || '???',
            kickerSlug: teamModule.kickerSlug || file.replace('.js', ''),
            marketValue: teamModule.marketValue || 100000000,
        };

        const content = formatSquadJs(meta, merged);

        if (dryRun) {
            console.log(`  [DRY-RUN] Would update ${file} (${merged.length} players)`);
        } else {
            fs.writeFileSync(teamPath, content, 'utf8');
            console.log(`  Updated ${file} (${merged.length} players)`);
        }
    }

    console.log('Done.');
}

main().catch((err) => {
    console.error(err);
    process.exit(1);
});
